Backup
------

There are three items you should back up.

1.  SCOT mongo database
2.  SCOT config files
3.  ElasticSearch Repos

Here's how to do it manually:

1.  Back up the mongo database with the "mongodump" command.

    $ cd /directory/with/space
    $ mongodump --db scot-prod 
    $ tar czvf /another/dir/scot-prod.tgz ./dump

2.  Use unix tools to copy SCOT config in /opt/scot/etc

3.  ElasticSearch backup is more involved:

    a.  if you have never backed up elastic, you will need to create
        a repo:

        $ curl -XPUT localhost:9200/_snapshot/scot_backup -d '{
        >    "scot_backup": {
        >         "type": "fs",
        >         "settings: {
        >             "compress": "true",
        >             "location": "/opt/esback"
        >         }
        >     }
        > }'

    b.  if you have already backup up once before, remove any conflicting
        snapshot (or use different snapshot name)

        $ curl -XDELETE localhost:9200/_snapshot/scot_backub/snapshot_1
        
    c.  Create the Snapshot:

        $ curl -XPUT localhost:9200/_snapshot/scot_backup/snapshot_1

    d.  Check on status:

        $ curl -XGET localhost:9200/_snapshot/scot_backup/_all

    e.  When complete, use tar to back up /opt/esback

        $ tar czvf /home/scot/esback.tgz /opt/esback

    f.  store scot-prod.tgz and esback.tgz in a safe place.

Restore
-------

1.  Restore Mongo:

   a.  remove existing scot-prod database
   
        $ mongo scot-prod < /opt/scot/etc/database/reset.js

    b.  extract scot-prod.tgz

        $ cd /home/scot
        $ tar xzvf /tmp/scot-prod.tgz 
        $ cd dump
        $ mongorestore --db=scot-prod .

2.  Restore configs by copying backup of /opt/scot/etc/ directory

3.  Restore ElasticSearch

    a.  Close ElasticSearch indexes that are active.

        $ curl -XPOST localhost:9200/scot/_close

    b.  Remove existing contents of /opt/esback

        $ rm -rf /opt/esback/*

    c.  extract esback.tgz

        $ cd /opt/esback
        $ tar xzvf /tmp/esback.tgz 

    d.  Make sure that /etc/elasticsearch/elasticsearch.yml has the following:

        repo.path: [ '/opt/esback' ]
        (restart es if you have to make a change to the yml file

    e.  Create the "scot_backup" repo if it doesn't exist (see above)

    f.  curl -XPOST localhost:9200/_snapshot/scot_backup/snapsot_1/_restore


Finally, restart scot.

    # service scot restart

